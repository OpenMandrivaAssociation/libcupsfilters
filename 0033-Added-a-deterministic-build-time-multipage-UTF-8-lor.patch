From 2f762327e1a123b995f4ead534e6f9e72457c2e0 Mon Sep 17 00:00:00 2001
From: Shreyansh Tiwari <127045990+shreyanshtiwari4@users.noreply.github.com>
Date: Sun, 8 Feb 2026 23:13:34 +0530
Subject: [PATCH 33/33] Added a deterministic build-time multipage UTF-8 lorem
 generator (#119)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Added a small build-time generator that produces a deterministic,
multi-page UTF-8 lorem text with extended Latin characters.

The generated file is used as input for texttopdf tests during
"make check" and is declared as a build artifact to ensure correct
dependency tracking and CI-safe execution.

This provides stable, reproducible text→PDF regression coverage.
---
 Makefile.am                       | 10 ++++
 cupsfilters/gen-lorem-text.c      | 99 +++++++++++++++++++++++++++++++
 cupsfilters/test-filter-cases.txt |  1 +
 3 files changed, 110 insertions(+)
 create mode 100644 cupsfilters/gen-lorem-text.c

diff --git a/Makefile.am b/Makefile.am
index 0c0daa80..94161d31 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -322,6 +322,16 @@ testfilters_LDFLAGS = \
 	-D_GNU_SOURCE \
 	-L/usr/lib
 
+noinst_PROGRAMS = gen-lorem-text
+gen_lorem_text_SOURCES = cupsfilters/gen-lorem-text.c
+EXTRA_DIST += cupsfilters/gen-lorem-text.c
+# Generated deterministic lorem text for texttopdf tests
+BUILT_SOURCES = cupsfilters/test_files/test_text_lorem.txt
+CLEANFILES   = cupsfilters/test_files/test_text_lorem.txt
+
+cupsfilters/test_files/test_text_lorem.txt: gen-lorem-text
+	$(AM_V_GEN)./gen-lorem-text > $@
+
 EXTRA_DIST += \
 	$(check_SCRIPTS) \
 	$(pkgfiltersinclude_DATA) \
diff --git a/cupsfilters/gen-lorem-text.c b/cupsfilters/gen-lorem-text.c
new file mode 100644
index 00000000..81a95915
--- /dev/null
+++ b/cupsfilters/gen-lorem-text.c
@@ -0,0 +1,99 @@
+/*Deterministically generate a long Lorem-Ipsum based text for tests.
+ * Usage: ./gen-lorem-text [repeats] > test_text_lorem.txt
+ *
+ * What This program does:
+ * - Uses a fixed publicly available Lorem paragraph.
+ * - Modifies some of the characters into special characters, i.e. "äöüßçáàñ...", based on fixed modification table. 
+ * - Modified paragraph is repeated N times separated by blank lines.
+ */
+
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <stdint.h>
+
+static const char *base_paragraph =
+"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin ac "
+"ligula id neque pulvinar interdum. Integer nec urna sit amet risus "
+"mollis dictum. Vivamus quis quam in est gravida pharetra. Fusce "
+"viverra, neque non commodo tempus, risus eros posuere lorem, eget "
+"vestibulum purus odio sit amet lacus. Donec vitae nisl at arcu "
+"vehicula faucibus. Cras tincidunt, nibh quis aliquet tincidunt, "
+"lectus dolor iaculis nunc, id fermentum dui orci at urna.";
+
+/* Deterministic modifications: we replace selected ASCII characters
+ * withspecial UTF-8 variants. The transformation depends on
+ * the character and the global position index so it's reproducible.
+ */
+static const char *replace_char(unsigned char c, unsigned long pos) {
+    /* Replace only a subset of letters to keep readability. */
+    /* Use pos to vary replacements deterministically. */
+    switch (c) {
+        case 'a':
+            if ((pos % 5) == 0) return "ä";
+            if ((pos % 8) == 0) return "á";
+            return "a";
+        case 'o':
+            if ((pos % 12) == 0) return "ö";
+            if ((pos % 7) == 0) return "ò";
+            return "o";
+        case 'u':
+            if ((pos % 13) == 0) return "ü";
+            return "u";
+        case 'b':
+            if ((pos % 17) == 0) return "ß";
+            return "b";
+        case 'c':
+            if ((pos % 19) == 0) return "ç";
+            return "c";
+        case 'n':
+            if ((pos % 23) == 0) return "ñ";
+            return "n";
+        case 'e':
+            if ((pos % 29) == 0) return "é";
+            return "e";
+        case 'i':
+            if ((pos % 31) == 0) return "í";
+            return "i";
+        default:
+            /* To emit the original byte */
+            return NULL;
+    }
+}
+
+int main(int argc, char *argv[]) {
+    unsigned long repeats = 150; /* default: ~150 paragraphs -> multi-page */
+    unsigned long i;
+    unsigned long global_pos = 1;
+
+    if (argc > 1) {
+        char *end;
+        unsigned long v = strtoul(argv[1], &end, 10);
+        if (end != argv[1] && v > 0) repeats = v;
+    }
+    printf("/* Generated by gen-lorem-text.c: repeats=%lu */\n\n", repeats);
+
+    for (i = 0; i < repeats; ++i) {
+        /* iterate bytes of base_paragraph and print with replacements */
+        const char *p = base_paragraph;
+        while (*p) {
+            unsigned char uc = (unsigned char)*p;
+            const char *rep = replace_char(uc, global_pos);
+            if (rep) {
+                fputs(rep, stdout);  /* rep is UTF-8 literal */
+            } else {
+                /* print ASCII byte as-is */
+                fputc(uc, stdout);
+            }
+            ++p;
+            ++global_pos;
+        }
+        /* Paragraph separator: two newlines -> makes pages when converted */
+        fputs("\n\n", stdout);
+    }
+
+    /* trailing newline */
+    fputs("\n", stdout);
+
+    return 0;
+}
\ No newline at end of file
diff --git a/cupsfilters/test-filter-cases.txt b/cupsfilters/test-filter-cases.txt
index cf61856e..edab5817 100644
--- a/cupsfilters/test-filter-cases.txt
+++ b/cupsfilters/test-filter-cases.txt
@@ -19,3 +19,4 @@ cupsfilters/test_files/test_file_4pg.pdf	application/pdf	cupsfilters/test_files/
 cupsfilters/test_files/test_file_4pg.pdf	application/pdf	cupsfilters/test_files/output_files/test_file_op.pwg	image/pwg-raster	Generic	PDF Color 2	1	1	image/pwg-raster,application/pdf	13	new-user	custom-print	5	sides=two-sided-short-edge media-size=A4 printer-resolution=300dpi
 cupsfilters/test_files/onepage-a4-adobe-rgb-8-150dpi.pwg	image/pwg-raster	cupsfilters/test_files/output_files/test_pwgtoraster.pdf	application/pdf	Generic	PDF Color 2	1 	1	application/pdf,image/pwg-raster	13	new-user	custom-print	5	sides=two-sided-short-edge media-size=A4 printer-resolution=300dpi
 cupsfilters/test_files/onepage-a4-adobe-rgb-8-150dpi.pwg	image/pwg-raster	cupsfilters/test_files/output_files/test_pwgtoraster.pclm	application/pclm	Generic	PDF Color 2	1 	1	application/pclm,image/pwg-raster	13	new-user	custom-print	5	sides=two-sided-short-edge media-size=A4 printer-resolution=300dpi
+cupsfilters/test_files/test_text_lorem.txt	text/plain	cupsfilters/test_files/output_files/output_text_lorem.pdf	application/pdf	Generic	PDF Color 2	1	1	text/plain,application/pdf	210	lorem-user	lorem-test	1
\ No newline at end of file
-- 
2.53.0

