From 08312616e637cc52a945c47c65cf4475b95d1f5d Mon Sep 17 00:00:00 2001
From: Abrar Nasir Jaffari <abrarnasirjaffari@gmail.com>
Date: Tue, 18 Mar 2025 14:39:24 +0500
Subject: [PATCH 02/33] Fixed Deadlock in Filter Chain When One Filter Fails
 (#85)

Fixes issue #32
---
 cupsfilters/filter.c | 85 ++++++++++++++++++++++++++++----------------
 1 file changed, 55 insertions(+), 30 deletions(-)

diff --git a/cupsfilters/filter.c b/cupsfilters/filter.c
index a5447040..1e4ae12c 100644
--- a/cupsfilters/filter.c
+++ b/cupsfilters/filter.c
@@ -22,6 +22,8 @@
 #include <cups/file.h>
 #include <cups/array.h>
 #include <cupsfilters/libcups2-private.h>
+#include <time.h>
+#include <unistd.h>
 
 
 extern char **environ;
@@ -814,14 +816,34 @@ cfFilterChain(int inputfd,         // I - File descriptor input stream
     close(filterfds[1][1]);
 
   //
-  // Wait for the children to exit...
+  // Start dynamic timeout clock on first filter exit.  When a filter
+  // process exits (zero or non-zero), record the time.  Then, if any
+  // filter continues running more than 60 seconds after that event,
+  // kill all remaining filter processes.
   //
-
-  retval = 0;
-
+  time_t first_exit_time = 0;
   while (cupsArrayGetCount(pids) > 0)
   {
-    if ((pid = wait(&status)) < 0)
+    pid = waitpid(-1, &status, WNOHANG);
+    if (pid == 0)
+    {
+      if (first_exit_time && (time(NULL) - first_exit_time) > 60)
+      {
+	if (log) log(ld, CF_LOGLEVEL_ERROR,
+		     "cfFilterChain: Timeout expired, killing hanging filters ...");
+	for (pid_entry = (filter_function_pid_t *)cupsArrayGetFirst(pids);
+	     pid_entry;
+	     pid_entry = (filter_function_pid_t *)cupsArrayGetNext(pids))
+        {
+	  kill(pid_entry->pid, SIGTERM);
+	  free(pid_entry);
+	}
+	break;
+      }
+      sleep(1);
+      continue;
+    }
+    else if (pid < 0)
     {
       if (errno == EINTR && iscanceled && iscanceled(icd))
       {
@@ -830,7 +852,7 @@ cfFilterChain(int inputfd,         // I - File descriptor input stream
 	for (pid_entry = (filter_function_pid_t *)cupsArrayGetFirst(pids);
 	     pid_entry;
 	     pid_entry = (filter_function_pid_t *)cupsArrayGetNext(pids))
-	{
+        {
 	  kill(pid_entry->pid, SIGTERM);
 	  free(pid_entry);
 	}
@@ -839,37 +861,40 @@ cfFilterChain(int inputfd,         // I - File descriptor input stream
       else
 	continue;
     }
-
-    key.pid = pid;
-    if ((pid_entry = (filter_function_pid_t *)cupsArrayFind(pids, &key)) !=
-	NULL)
+    else
     {
-      cupsArrayRemove(pids, pid_entry);
-
-      if (status)
+      key.pid = pid;
+      if ((pid_entry = (filter_function_pid_t *)cupsArrayFind(pids, &key)) != NULL)
       {
-	if (WIFEXITED(status))
-	{
-	  if (log) log(ld, CF_LOGLEVEL_ERROR,
-		       "cfFilterChain: %s (PID %d) stopped with status %d",
-		       pid_entry->name, pid, WEXITSTATUS(status));
+	cupsArrayRemove(pids, pid_entry);
+	if (status)
+        {
+	  if (WIFEXITED(status))
+          {
+	    if (log) log(ld, CF_LOGLEVEL_ERROR,
+			 "cfFilterChain: %s (PID %d) stopped with status %d",
+			 pid_entry->name, pid, WEXITSTATUS(status));
+	    if (WEXITSTATUS(status))
+	      retval = 1;
+	  }
+	  else
+          {
+	    if (log) log(ld, CF_LOGLEVEL_ERROR,
+			 "cfFilterChain: %s (PID %d) crashed on signal %d",
+			 pid_entry->name, pid, WTERMSIG(status));
+	  }
+	  retval = 1;
 	}
 	else
-	{
-	  if (log) log(ld, CF_LOGLEVEL_ERROR,
-		       "cfFilterChain: %s (PID %d) crashed on signal %d",
-		       pid_entry->name, pid, WTERMSIG(status));
-	}
-	retval = 1;
-      }
-      else
-      {
-	if (log) log(ld, CF_LOGLEVEL_INFO,
+        {
+	  if (log) log(ld, CF_LOGLEVEL_INFO,
 		       "cfFilterChain: %s (PID %d) exited with no errors.",
 		       pid_entry->name, pid);
+	}
+	free(pid_entry);
+	if (retval && !first_exit_time)
+	  first_exit_time = time(NULL);
       }
-
-      free(pid_entry);
     }
   }
 
-- 
2.53.0

