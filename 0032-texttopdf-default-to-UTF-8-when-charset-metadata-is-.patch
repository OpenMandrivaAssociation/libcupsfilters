From 320127fd112942230a11be7dd1b5deccbcdcf952 Mon Sep 17 00:00:00 2001
From: Shreyansh Tiwari <127045990+shreyanshtiwari4@users.noreply.github.com>
Date: Sun, 8 Feb 2026 23:10:31 +0530
Subject: [PATCH 32/33] texttopdf: default to UTF-8 when charset metadata is
 missing (#120)

texttopdf relies entirely on charset metadata to activate its UTF-8
and Unicode rendering path. In many real-world jobs, charset metadata is missing. So, even when input is UTF-8., the code
silently falls back to ASCII output using Type1 fonts.

Default to UTF-8 when no charset metadata is present so the existing
Unicode pipeline (charset files, Fontconfig, CID Type0 fonts, and
ToUnicode mappings) is correctly activated.
---
 cupsfilters/texttopdf.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/cupsfilters/texttopdf.c b/cupsfilters/texttopdf.c
index 8e6f528c..e89a7d6f 100644
--- a/cupsfilters/texttopdf.c
+++ b/cupsfilters/texttopdf.c
@@ -1958,6 +1958,14 @@ write_prolog(const char *title,		// I - Title of job
   // Get the output character set...
   //
 
+  //
+  // If no charset was provided by the filter framework, or metadata,
+  // default to UTF-8 so that Unicode charsets can be resolved, as this value
+  // is directly used in charset value to activate UTF-8 path.
+  //
+  if (!doc->env_vars.char_set)
+    doc->env_vars.char_set = "utf-8";
+
   charset = doc->env_vars.char_set;
   if (charset != NULL && strcmp(charset, "us-ascii") != 0) // {{{
   {
-- 
2.53.0

